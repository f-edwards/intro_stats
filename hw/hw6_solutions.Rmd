---
title: "HW7"
author: "Frank Edwards"
date: "`r Sys.Date()`"
output: html_document
---

Use the UCR 2022 Arrests by Age, Sex, and Race data for this assignment. You will need to refer to the included codebook for this assignment. 

The data are available for download here: https://www.icpsr.umich.edu/web/NACJD/studies/39063

```{r}
library(tidyverse)
dat<-read_tsv("../data/ICPSR_39063/DS0002/39063-0002-Data.tsv")
```

1. Load the 12-month data into R using the `read_tsv` command

2. Using the variables `AW`, `AB`, `AI`, `AA`, and `POP`, create a new data frame that includes a variable called `arrests_Per100k` that computes the arrest rate per 100,000 population for each agency in the data. Consider how you will handle missing values, and agencies that report no population.

```{r}
dat<-dat %>% 
  mutate(AW = ifelse(AW == max(dat$AW), NA, AW),
         AB = ifelse(AB == max(dat$AB), NA, AB),
         AI = ifelse(AI == max(dat$AI), NA, AI),
         AA = ifelse(AA == max(dat$AA), NA, AA)) %>% 
  mutate(total_arrest_rate = (AW + AB + AI + AA) / POP * 1e5)

```

3. Subset this data frame to include only agencies covering more than 10,000 population and only arrests for fraud and for forgery and counterfeiting. How many fewer rows does this new data frame contain when compared to the original data?

```{r}
dat_bigpop<-dat %>% 
  filter(POP>10000,
         OFFENSE == "100" | OFFENSE == "110")
```

4. Use pivot_wider to create two new columns: one for the fraud arrest rate and another for the forgery and counterfeiting arrest rate. Then scatterplot these two arrest rates and describe their joint distribution.

```{r}
dat_bigpop<-dat_bigpop %>% 
  select(STNAME, ORI, OFFENSE, POP, total_arrest_rate) %>% 
  pivot_wider(names_from = OFFENSE, 
              values_from = total_arrest_rate) %>% 
  rename(fraud = `100`, counterfeiting = `110`)

ggplot(dat_bigpop,
       aes(x = fraud,
           y = counterfeiting)) + 
  geom_point()
```

5. For each state, compute the average agency-level arrest rates for both fraud and counterfeiting. Create a barplot to show your findings and interpret. 

```{r}
dat_state<-dat_bigpop %>% 
  group_by(STNAME) %>% 
  summarize(fraud = mean(fraud, na.rm = T),
            counterfeiting = mean(counterfeiting, na.rm = T))

ggplot(dat_state,
       aes(y = STNAME,
           x = fraud)) + 
  geom_col()

ggplot(dat_state,
       aes(y = STNAME,
           x = counterfeiting)) + 
  geom_col()
```

6. Now, for each state compute the state-level arrest rate for both fraud and counterfeiting. Create a barplot to show your findings. 

```{r}
dat_state2<-dat_bigpop %>% 
  mutate(fraud_n = fraud / 1e5 * POP,
         counterfeiting_n = counterfeiting / 1e5 * POP) %>% 
  group_by(STNAME) %>% 
  summarize(fraud_st = sum(fraud_n, na.rm=T)/ 
              sum(POP, na.rm=T) * 1e5,
            counterfeiting_st = sum(counterfeiting_n, na.rm=T)/
              sum(POP, na.rm=T) * 1e5)

ggplot(dat_state2,
       aes(y = STNAME,
           x = fraud_st)) + 
  geom_col()

ggplot(dat_state2,
       aes(y = STNAME,
           x = counterfeiting_st)) + 
  geom_col()
```

7. Consider carefully the difference between agency-level and state-level arrest rates, and explain the differences you observe between the two plots. (Hint: a supplemental histogram or two might be very helpful to figure out what's going on)

```{r}
## mean of agency rates by state
summary(dat_state$fraud)
## state-level rates
summary(dat_state2$fraud_st)


ggplot(dat_state,
       aes(x = fraud)) + 
  geom_histogram() + 
  labs(title = "Agency-level mean arrest rates by state")

ggplot(dat_state2,
       aes(x = fraud_st)) + 
  geom_histogram() + 
  labs(title = "State-level average arrests")
```

