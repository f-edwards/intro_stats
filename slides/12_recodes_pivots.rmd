---
title: "Recodes and pivots"
author: "Frank Edwards"
output: binb::metropolis
---

```{r message = FALSE, warning = FALSE, echo = FALSE}
library(tidyverse)

knitr::opts_chunk$set(tidy = FALSE)
theme_set(theme_bw())
def.chunk.hook  <- knitr::knit_hooks$get("chunk")
knitr::knit_hooks$set(chunk = function(x, options) {
  x <- def.chunk.hook(x, options)
  ifelse(options$size != "normalsize", paste0("\\", options$size,"\n\n", x, "\n\n \\normalsize"), x)
})
knitr::opts_chunk$set(warning=FALSE, message=FALSE, tidy = F, size = "small")
```

## Data for today

```{r}
dat<-read_csv("./data/criminalrecord.csv")
```


## Recoding and conditionals

Let's make distance categorical, with cuts at the 25th, 50th, and 75th quantile

```{r}
summary(dat$distance)
## NA???
```

## Filter out missing values

```{r}
## remove pesky NA values
dat_clean<-dat %>% 
  filter(!(is.na(distance)))
         
summary(dat_clean$distance)
```

## Visualizing quantiles: area under the curve

```{r echo = FALSE, warning = FALSE}
ggplot(dat_clean, aes(x=distance)) + geom_density() + 
  geom_vline(aes(xintercept = median(distance)), 
             lty=2) + 
  geom_vline(aes(xintercept = quantile(distance, 0.25)), lty=3) +
  geom_vline(aes(xintercept = quantile(distance, 0.75)), lty=3)
```

## Making a recode with one condition

Make a new variable for distance, with value T if below the median, and F if above
```{r size = "tiny"}
dat_clean<-dat_clean %>% 
  mutate(distance_binary = distance < median(distance)) 
```

## Making a recode with one condition: ifelse()

Make a new variable for distance, with value "near" if below the median, and "far" if above
```{r size = "tiny"}
dat_clean<-dat_clean %>% 
  mutate(distance_binary2 = ifelse(
    distance < median(distance), 
    "near",
    "far"))
```

## Making a recode with multiple conditions

```{r size = "tiny"}
### define quartile cut points
q1<-quantile(dat_clean$distance, 0.25)
q2<-quantile(dat_clean$distance, 0.5)
q3<-quantile(dat_clean$distance, 0.75)
q1; q2; q3

```

## Making a recode with multiple conditions: case_when()

```{r size = "tiny"}

### make factor variable
dat_clean <- dat_clean %>% 
  mutate(distance_quartile = 
           case_when(
             distance < q1 ~ "1st",
             distance < q2 ~ "2nd",
             distance < q3 ~ "3rd",
             distance >= q3 ~ "4th"
           ))

dat_clean <- dat_clean |> 
  mutate(crimrec = ifelse(crimrec == 1, 
                          "record", 
                          "no record"),
         distance_q = case_when(
           is.na(distance) ~ NA,
           distance >= quantile(distance, 0.8) ~ "far",
           distance >= quantile(distance, 0.65) ~ "kinda",
           distance < quantile(distance, 0.65) ~ "close",
           T ~ "other"),
         race = ifelse(black == 1 , "Black", "White"))

```

## Practice recodes

- Recode crimrec to be equal to "record" if 1; and "no record" if 0
- Recode distance to be 'far' if at the 80th percentile; 'kinda' if at the 65th percentile, and 'close' otherwise
- Create a new variable called 'race' and use values from 'black' to create sensible values.

# Pivots and more recodes with HW6

